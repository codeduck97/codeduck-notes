**ğŸŒ³æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰**å¹¶ä¸æ˜¯æ‰€è°“çš„å­˜å‚¨æ–¹æ³•çš„åŒºåŸŸï¼Œè€Œæ˜¯ä¾›å„çº¿ç¨‹å…±äº«çš„è¿è¡Œæ—¶å†…å­˜åŒºåŸŸã€‚**å®ƒå­˜å‚¨äº†å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€å¸¸é‡ã€åŸŸï¼ˆfieldï¼‰ä¿¡æ¯ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚**

æ–¹æ³•åŒºä¹Ÿæ˜¯**ä¸€ç§è§„èŒƒ**ï¼Œåœ¨ä¸åŒè™šæ‹Ÿæœºé‡Œå¤´å®ç°æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€å…¸å‹çš„å®ç°å°±æ˜¯HotSpotè™šæ‹ŸæœºJava8ä¹‹å‰çš„æ°¸ä¹…ä»£(PermGen space)å’ŒJava8çš„å…ƒç©ºé—´(Metaspace)ã€‚

![image-20210609084306427](images/image-20210609084306427.png)

# 1. è®¾ç½®æ–¹æ³•åŒºå¤§å°

æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥åŠ è½½å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹Ÿæœºåˆ™ä¼šæŠ›å‡ºjava.lang.OutOfMemoryError: PermGen spaceï¼ˆJava 7ï¼‰æˆ–è€…java.lang.OutOfMemoryError: Metaspaceï¼ˆJava 8ï¼‰å†…å­˜æº¢å‡ºé”™è¯¯ã€‚

ä»¥Java8ç‰ˆæœ¬ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`-XX:MetaspaceSize=size`è®¾ç½®å…ƒç©ºé—´åˆå§‹å¤§å°ï¼Œ`-XX:MaxMetaspaceSize=size`è®¾ç½®å…ƒç©ºé—´æœ€å¤§å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨windowså¹³å°ä¸Šï¼Œ`-XX:MetaspaceSize`å€¼ä¸º21Mï¼Œ`-XX:MaxMetaspaceSize`å€¼ä¸º-1ï¼Œå³æ²¡æœ‰é™åˆ¶ï¼Œæ‰€ä»¥æç«¯æƒ…å†µä¸‹å¦‚æœä¸æ–­åœ°åŠ è½½ç±»ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰å¯ç”¨çš„ç³»ç»Ÿå†…å­˜ã€‚

ä¸‹é¢ä¸¾ä¸ªå…ƒç©ºé—´OOMçš„ä¾‹å­ï¼š

```java
import com.sun.org.apache.bcel.internal.util.ClassLoader;
import com.sun.xml.internal.ws.org.objectweb.asm.ClassWriter;
import jdk.internal.org.objectweb.asm.Opcodes;

public class Test extends ClassLoader {

    public static void main(String[] args) {
        int count = 0;
        try {
            Test test = new Test();
            for (int i = 0; i < 10000; i++) {
                String className = "Class" + i;
                // åˆ›å»ºClassWriterå¯¹è±¡ï¼Œç”¨äºç”Ÿæˆç±»çš„äºŒè¿›åˆ¶å­—èŠ‚ç 
                ClassWriter classWriter = new ClassWriter(0);
                // æŒ‡å®šç‰ˆæœ¬å·ã€ä¿®é¥°ç¬¦ã€ç±»åã€åŒ…åã€çˆ¶ç±»å’Œæ¥å£
                classWriter.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, className, null, "java/lang/Object", null);
                byte[] bytes = classWriter.toByteArray();
                // åŠ è½½ç±»
                test.defineClass(className, bytes, 0, bytes.length);
                count++;
            }
        } finally {
            System.out.println(count);
        }
    }
}
```

ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°è¯•åŠ è½½10000ä¸ªç±»ï¼Œé€šè¿‡å‚æ•°`-XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=10m`å°†å…ƒç©ºé—´å¤§å°è®¾ç½®ä¸ºå›ºå®šå¤§å°10Mï¼Œè¿è¡Œä¸Šé¢çš„ç¨‹åºæ§åˆ¶å°è¾“å‡ºï¼š

![QQ20200630-110519@2x](https://mrbird.cc/img/QQ20200630-110519@2x.png)

# 2. æ–¹æ³•åŒºã€å †ã€æ ˆå…³ç³»

æ–¹æ³•åŒºå’Œå †ã€æ ˆçš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```java
public class Bird {

    public static void main(String[] args) {
        Bird bird = new Bird();
    }
}
```

![image-20200828145953651](images/image-20200828145953651.png)

# 3. æ–¹æ³•åŒºå†…éƒ¨ç»“æ„

æ–¹æ³•åŒºå†…éƒ¨ä¸»è¦å­˜å‚¨äº†ä»¥ä¸‹å†…å®¹ï¼ˆä¸åŒJDKç‰ˆæœ¬å†…å®¹æœ‰æ‰€ä¸åŒï¼Œå…·ä½“å‚è€ƒä¸‹é¢â€œæ–¹æ³•åŒºæ¼”è¿›â€ï¼‰ï¼š

## 3.1 ç±»å‹ä¿¡æ¯

å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±»classã€æ¥å£ interfaceã€æšä¸¾enumã€æ³¨è§£ annotationï¼‰ï¼ŒJVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š

1. æ˜¯ç±»è¿˜æ˜¯æ¥å£ï¼›
2. è¿™ä¸ªç±»çš„å…¨é™å®šåï¼ˆåŒ…å.ç±»åï¼‰ï¼›
3. è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å…¨é™å®šåï¼ˆinterfaceå’Œjava.lang.Objectæ²¡æœ‰çˆ¶ç±»ï¼‰ï¼›
4. è¿™ä¸ªç±»çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œabstractï¼Œfinalï¼‰ï¼›
5. è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼ˆä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼‰ã€‚

## 3.2 æ–¹æ³•ä¿¡æ¯

æ–¹æ³•ä¿¡æ¯åŒ…å«äº†è¿™ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ„é€ å™¨ï¼‰ï¼Œè¿™äº›ä¿¡æ¯å’Œå…¶å£°æ˜é¡ºåºä¸€è‡´ï¼š

1. æ–¹æ³•åç§°ï¼›
2. æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼ˆæ²¡æœ‰è¿”å›å€¼åˆ™æ˜¯voidï¼‰ï¼›
3. æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹ï¼ˆæœ‰åºï¼‰ï¼›
4. æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œsynchronizedï¼Œnativeï¼Œabstractï¼‰ï¼›
5. æ–¹æ³•çš„å­—èŠ‚ç ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå…¶å¤§å°ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰ï¼›
6. å¼‚å¸¸è¡¨ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰ã€‚

## 3.3 åŸŸä¿¡æ¯

åŸŸFieldæˆ‘ä»¬ä¹Ÿå¸¸ç§°ä¸ºå±æ€§ï¼Œå­—æ®µã€‚åŸŸä¿¡æ¯åŒ…å«ï¼š

1. åŸŸçš„å£°æ˜é¡ºåºï¼›
2. åŸŸçš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€ç±»å‹ã€ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œvolatileï¼Œtransientï¼‰ã€‚

## 3.4 JITä»£ç ç¼“å­˜

è¿™éƒ¨åˆ†åœ¨ğŸ‘‡æ‰§è¡Œå¼•æ“ä¸­å†åšè¯´æ˜ã€‚
https://www.cnblogs.com/code-duck/p/13568123.html

## 3.5 è¿è¡Œæ—¶å¸¸é‡æ± 

**ğŸŒ³è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰**ï¼Œå®ƒæ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚Classæ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ç­‰ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯**å¸¸é‡æ± ï¼ˆConstant Pool Tableï¼‰**ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨**ç±»åŠ è½½åå­˜æ”¾åˆ°è¿è¡Œæ—¶å¸¸é‡æ± **ä¸­ã€‚

ç±»ç¼–è¯‘åçš„Classæ–‡ä»¶ä¼šæœ‰ä¸€ä¸ªconstant poolçš„ç»“æ„ï¼Œä¿—ç§°ä¸º**å¸¸é‡æ± **ï¼Œ**æ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ä¿å­˜åœ¨classæ–‡ä»¶çš„å¸¸é‡æ± é‡Œã€‚**è™šæ‹Ÿæœºæ ˆçš„åŠ¨æ€é“¾æ¥å°±æ˜¯å°†ç¬¦å·å¼•ç”¨ï¼ˆè¿™äº›ç¬¦å·å¼•ç”¨çš„é›†åˆå°±æ˜¯å¸¸é‡æ± ï¼‰è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆ`ç¬¦å·å¼•ç”¨å¯¹åº”çš„å…·ä½“ä¿¡æ¯ï¼Œè¿™äº›å…·ä½“ä¿¡æ¯çš„é›†åˆå°±æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå­˜åœ¨æ–¹æ³•åŒºä¸­`ï¼‰çš„è¿‡ç¨‹ã€‚

**å¸¸é‡æ± åŒ…å«çš„å†…å®¹æœ‰ï¼š**

- ç›´æ¥å¸¸é‡ï¼š
      CONSTANT_INGETER_INFO æ•´å‹ç›´æ¥å¸¸é‡æ±    ï¼ˆpublic final int CONST_INT=0;ï¼‰
      CONSTANT_STRING_INFO å­—ç¬¦ä¸²ç›´æ¥å¸¸é‡æ±   ï¼ˆpublic final String CONST_STR="CONST_STR";ï¼‰
      CONSTANT_DOUBLE_INFO æµ®ç‚¹å‹ç›´æ¥å¸¸é‡æ±  ï¼ˆpublic final int CONST_DOUBLE= 0.0;ï¼‰
      ç­‰ç­‰å„ç§åŸºæœ¬æ•°æ®ç±»å‹åŸºç¡€å¸¸é‡æ± ã€‚
- æ–¹æ³•å
- æ–¹æ³•æè¿°ç¬¦
- ç±»å
- å­—æ®µå
- å­—æ®µæè¿°ç¬¦çš„ç¬¦å·å¼•ç”¨

## 3.6 é™æ€å˜é‡

é™æ€å˜é‡å°±æ˜¯ä½¿ç”¨staticä¿®é¥°çš„åŸŸä¿¡æ¯ã€‚é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œå®ƒä»¬æˆä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†ã€‚é™æ€å˜é‡ä¹Ÿæˆä¸ºç±»å˜é‡ï¼Œç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰ç±»å®ä¾‹æ—¶ä½ ä¹Ÿå¯ä»¥è®¿é—®å®ƒï¼š

```java
public class Test {

    private static String hello = "hello";

    private static void hello() {
        System.out.println("hello");
    }

    public static void main(String[] args) {
        Test test = null;
        test.hello();
        System.out.println(test.hello);
    }
}
```

ä¸Šé¢ç¨‹åºè¿è¡Œå¹¶ä¸ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚

**é€šè¿‡finalä¿®é¥°çš„é™æ€å˜é‡æˆ‘ä»¬ä¿—ç§°å¸¸é‡**ã€‚å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…å…·ä½“å€¼ï¼š

```java
public class Test {

    private static String hello = "hello";
    private static final String HELLO = "hello";
}
```

é€šè¿‡`javap -v -p Test.class`æŸ¥çœ‹å…¶å­—èŠ‚ç ï¼š

![QQ20200630-170711@2x](https://mrbird.cc/img/QQ20200630-170711@2x.png)

é€šè¿‡ä¸Šé¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œé™æ€å˜é‡ï¼ˆç±»å˜é‡ï¼‰åœ¨ç±»åŠ è½½è¿‡ç¨‹çš„åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šè¢«èµ‹å€¼ã€‚

## 3.7 æ¼”ç¤ºæ–¹æ³•åŒºå†…éƒ¨ç»“æ„

ä¸‹é¢é€šè¿‡å­—èŠ‚ç å†…å®¹æ¥æŸ¥çœ‹ä¸Šé¢è¿™äº›ä¿¡æ¯ï¼Œç°æœ‰å¦‚ä¸‹ä»£ç ï¼š

```java
public class Test extends Object implements Cloneable, Serializable {

    private static String hello = "hello";
    private static final String HELLO = "hello";
    public int a = 0;

    public void method1() {
        System.out.println("method1");
    }

    public static String method2(String name) {
        try {
            int a = 1;
            int b = a / 0;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return name;
    }
}
```

é€šè¿‡`javap -v -p Test.class`æŸ¥çœ‹å…¶å­—èŠ‚ç ï¼š

```java
Classfile /Users/mrbird/idea workspace/JVM-Learn/target/classes/cc/mrbird/jvm/learn/Test.class
  Last modified 2019-4-01; size 1016 bytes
  MD5 checksum ab0309674b0f0b5fbd0766af035efe0a
  Compiled from "Test.java"
// ç±»å‹ä¿¡æ¯
public class cc.mrbird.jvm.learn.Test implements java.lang.Cloneable,java.io.Serializable
  minor version: 0
  major version: 52
  // ç±»çš„ä¿®é¥°ç¬¦
  flags: ACC_PUBLIC, ACC_SUPER
// å¸¸é‡æ± 
Constant pool:
   #1 = Methodref          #11.#38        // java/lang/Object."<init>":()V
   #2 = Fieldref           #10.#39        // cc/mrbird/jvm/learn/Test.a:I
   #3 = Fieldref           #40.#41        // java/lang/System.out:Ljava/io/PrintStream;
   #4 = String             #27            // method1
   #5 = Methodref          #42.#43        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #6 = Class              #44            // java/lang/Exception
   #7 = Methodref          #6.#45         // java/lang/Exception.printStackTrace:()V
   #8 = String             #14            // hello
   #9 = Fieldref           #10.#46        // cc/mrbird/jvm/learn/Test.hello:Ljava/lang/String;
  #10 = Class              #47            // cc/mrbird/jvm/learn/Test
  #11 = Class              #48            // java/lang/Object
  #12 = Class              #49            // java/lang/Cloneable
  #13 = Class              #50            // java/io/Serializable
  #14 = Utf8               hello
  #15 = Utf8               Ljava/lang/String;
  #16 = Utf8               HELLO
  #17 = Utf8               ConstantValue
  #18 = Utf8               a
  #19 = Utf8               I
  #20 = Utf8               <init>
  #21 = Utf8               ()V
  #22 = Utf8               Code
  #23 = Utf8               LineNumberTable
  #24 = Utf8               LocalVariableTable
  #25 = Utf8               this
  #26 = Utf8               Lcc/mrbird/jvm/learn/Test;
  #27 = Utf8               method1
  #28 = Utf8               method2
  #29 = Utf8               (Ljava/lang/String;)Ljava/lang/String;
  #30 = Utf8               e
  #31 = Utf8               Ljava/lang/Exception;
  #32 = Utf8               name
  #33 = Utf8               StackMapTable
  #34 = Class              #44            // java/lang/Exception
  #35 = Utf8               <clinit>
  #36 = Utf8               SourceFile
  #37 = Utf8               Test.java
  #38 = NameAndType        #20:#21        // "<init>":()V
  #39 = NameAndType        #18:#19        // a:I
  #40 = Class              #51            // java/lang/System
  #41 = NameAndType        #52:#53        // out:Ljava/io/PrintStream;
  #42 = Class              #54            // java/io/PrintStream
  #43 = NameAndType        #55:#56        // println:(Ljava/lang/String;)V
  #44 = Utf8               java/lang/Exception
  #45 = NameAndType        #57:#21        // printStackTrace:()V
  #46 = NameAndType        #14:#15        // hello:Ljava/lang/String;
  #47 = Utf8               cc/mrbird/jvm/learn/Test
  #48 = Utf8               java/lang/Object
  #49 = Utf8               java/lang/Cloneable
  #50 = Utf8               java/io/Serializable
  #51 = Utf8               java/lang/System
  #52 = Utf8               out
  #53 = Utf8               Ljava/io/PrintStream;
  #54 = Utf8               java/io/PrintStream
  #55 = Utf8               println
  #56 = Utf8               (Ljava/lang/String;)V
  #57 = Utf8               printStackTrace
{

  // åŸŸä¿¡æ¯
  private static java.lang.String hello;
    descriptor: Ljava/lang/String;
    flags: ACC_PRIVATE, ACC_STATIC
  // åŸŸä¿¡æ¯
  private static final java.lang.String HELLO;
    descriptor: Ljava/lang/String;
    flags: ACC_PRIVATE, ACC_STATIC, ACC_FINAL
    ConstantValue: String hello
  // åŸŸä¿¡æ¯
  public int a;
    descriptor: I
    flags: ACC_PUBLIC
  // æ–¹æ³•ä¿¡æ¯
  public cc.mrbird.jvm.learn.Test();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: aload_0
         5: iconst_0
         6: putfield      #2                  // Field a:I
         9: return
      LineNumberTable:
        line 5: 0
        line 9: 4
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      10     0  this   Lcc/mrbird/jvm/learn/Test;
  // æ–¹æ³•ä¿¡æ¯
  public void method1();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      // æ“ä½œæ•°æ ˆå¤§å°ï¼Œå±€éƒ¨å˜é‡è¡¨å¤§å°ï¼Œå‚æ•°ä¸ªæ•°
      stack=2, locals=1, args_size=1
         0: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #4                  // String method1
         5: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
      LineNumberTable:
        line 12: 0
        line 13: 8
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       9     0  this   Lcc/mrbird/jvm/learn/Test;
  // æ–¹æ³•ä¿¡æ¯
  public static java.lang.String method2(java.lang.String);
    descriptor: (Ljava/lang/String;)Ljava/lang/String;
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=3, args_size=1
         0: iconst_1
         1: istore_1
         2: iload_1
         3: iconst_0
         4: idiv
         5: istore_2
         6: goto          14
         9: astore_1
        10: aload_1
        11: invokevirtual #7                  // Method java/lang/Exception.printStackTrace:()V
        14: aload_0
        15: areturn
      // å¼‚å¸¸è¡¨
      Exception table:
         from    to  target type
             0     6     9   Class java/lang/Exception
      LineNumberTable:
        line 17: 0
        line 18: 2
        line 21: 6
        line 19: 9
        line 20: 10
        line 22: 14
      // å±€éƒ¨å˜é‡è¡¨
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            2       4     1     a   I
           10       4     1     e   Ljava/lang/Exception;
            0      16     0  name   Ljava/lang/String;
      StackMapTable: number_of_entries = 2
        frame_type = 73 /* same_locals_1_stack_item */
          stack = [ class java/lang/Exception ]
        frame_type = 4 /* same */

  static {};
    descriptor: ()V
    flags: ACC_STATIC
    Code:
      stack=1, locals=0, args_size=0
         0: ldc           #8                  // String hello
         2: putstatic     #9                  // Field hello:Ljava/lang/String;
         5: return
      LineNumberTable:
        line 7: 0
}
SourceFile: "Test.java"
```

# 4. æ–¹æ³•åŒºçš„æ¼”è¿›

éšç€JDKçš„è¿­ä»£å‡çº§ï¼ŒHotspotä¸­æ–¹æ³•åŒºçš„å­˜å‚¨çš„å†…å®¹å‘ç”Ÿäº†å¦‚ä¸‹å˜åŒ–ï¼ˆä¸Šé¢ä»‹ç»çš„æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„æ˜¯ç»å…¸æƒ…å†µä¸‹çš„ï¼Œå…·ä½“è¿˜æ˜¯éœ€è¦çœ‹JDKæ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼‰ï¼š

| ç‰ˆæœ¬         | æè¿°                                                         |
| :----------- | :----------------------------------------------------------- |
| jdk1.6åŠä¹‹å‰ | æœ‰æ°¸ä¹…ä»£ï¼ˆpermanent generationï¼‰ï¼Œ**é™æ€å˜é‡å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸Š** |
| jdk1.7       | æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥â€œå»æ°¸ä¹…ä»£â€ï¼Œ**å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­** |
| jdk1.8åŠä¹‹å | æ— æ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€**å¸¸é‡**ä¿å­˜åœ¨**æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´**ï¼Œä½†**å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»ç„¶ä¿å­˜åœ¨å †ä¸­** |

![image-20210609090926950](images/image-20210609090926950.png)

ä¸Šé¢è¯´çš„é™æ€å˜é‡åœ¨JDK1.6ä¹‹å‰å­˜æ”¾åœ¨æ°¸ä¹…ä»£ï¼ŒJDK1.7åç§»åŠ¨åˆ°å †ç©ºé—´æŒ‡çš„æ˜¯å˜é‡æœ¬èº«ï¼Œå˜é‡å¯¹åº”çš„å¯¹è±¡å®ä¾‹ä¸€ç›´éƒ½æ˜¯åœ¨å †ç©ºé—´åˆ†é…çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```java
public class StaticObjTest {

    static class Test {
        static ObjectHolder staticObj = new ObjectHolder();
        ObjectHolder instanceObj = new ObjectHolder();

        void foo() {
            ObjectHolder localObj = new ObjectHolder();
        }
    }

    private static class ObjectHolder {

    }
}
```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸‰ä¸ªnew ObjectHolder()çš„åˆ›å»ºï¼Œéƒ½æ˜¯åœ¨å †ä¸­åˆ†é…çš„ï¼ŒlocalObjæ˜¯æ–¹æ³•fooå†…çš„å±€éƒ¨å˜é‡ï¼Œå­˜æ”¾åœ¨è™šæ‹Ÿæœºæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼›instanceObjä¸ºæˆå‘˜å˜é‡ï¼Œéšç€å¯¹è±¡å®ä¾‹çš„åˆ›å»ºä¹Ÿåˆ†é…åœ¨å †ä¸­ï¼›é™æ€å˜é‡staticObjæ ¹æ®JDKç‰ˆæœ¬çš„ä¸åŒå­˜æ”¾ä½ç½®ä¹Ÿä¸åŒï¼ŒJDK1.6åŠä¹‹å‰ï¼Œå­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸­ï¼ŒJDK1.7åŠä¹‹åå­˜æ”¾åˆ°å †ä¸­ã€‚

## æ°¸ä¹…ä»£ä¸å…ƒç©ºé—´

**æ°¸ä¹…ä»£ä¸ºä»€ä¹ˆä¼šè¢«å…ƒç©ºé—´æ›¿ä»£ï¼Ÿ**å› ä¸ºæ°¸ä¹…ä»£çš„å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºåŠ¨æ€åŠ è½½çš„ç±»è¿‡å¤šå°±å¾ˆå®¹æ˜“è§¦å‘æ°¸ä¹…ä»£çš„Full GCï¼ˆFull GCä»£ä»·å¤§ï¼Œè€—æ—¶é•¿ï¼Œå½±å“ç¨‹åºæ€§èƒ½ï¼‰ç”šè‡³OOMï¼Œç¨‹åºç›´æ¥å¥”æºƒï¼›

è€Œå…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼š**å…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œ**è¿™æ ·å…ƒç©ºé—´å°±åŸºæœ¬ä¸ä¼šè§¦å‘Full GCå’ŒOOMäº†ã€‚

**å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆStringTableï¼‰ä¸ºä»€ä¹ˆè¦æ”¾åˆ°å †ä¸­ï¼Ÿ**å› ä¸ºå¦‚æœå°†StringTableæ”¾åœ¨æ°¸ä¹…ä»£çš„è¯å›æ”¶æ•ˆç‡å¾ˆä½ï¼Œåœ¨Full GCçš„æ—¶å€™æ‰ä¼šè§¦å‘ã€‚è€ŒFull GCæ˜¯è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ã€æ°¸ä¹…ä»£ä¸è¶³æ—¶æ‰ä¼šè§¦å‘ã€‚è¿™å°±å¯¼è‡´ StringTableå›æ”¶æ•ˆç‡ä¸é«˜ã€‚è€Œæˆ‘ä»¬å¼€å‘ä¸­ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²è¢«åˆ›å»ºï¼Œå›æ”¶æ•ˆç‡ä½ï¼Œå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜ä¸è¶³ã€‚æ”¾åˆ°å †é‡Œï¼Œèƒ½åŠæ—¶å›æ”¶å†…å­˜ã€‚

# 5.æ–¹æ³•åŒºåƒåœ¾å›æ”¶

æ–¹æ³•åŒºä¹Ÿå­˜åœ¨åƒåœ¾å›æ”¶ï¼Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚